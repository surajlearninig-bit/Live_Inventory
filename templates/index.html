<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | IT Asset Inventory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        *{
            box-sizing:border-box;
            font-family:'Inter',sans-serif;
        }
        body{
            margin:0;
            background:#f1f5f9;
            display:flex;
        }
        .sidebar{
            width:200px;
            background:#020617;
            color:#fff;
            height:100vh;
            padding:20px;
        }
        .sidebar h2{
            margin-top:0;
            margin-bottom:30px;
            font-size:20px;
        }
        .nav-item{
            padding:12px;
            border-radius:6px;
            cursor:pointer;
            margin-bottom:8px;
            font-size:14px;
        }
        .nav-item:hover{
            background:#1e293b;
        }
        .main{
            flex:1;
            padding:20px;
        }
        .header{
            background:#fff;
            padding:15px 20px;
            border-radius:10px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            box-shadow:0 4px 12px rgba(0,0,0,0.04);
            margin-bottom:25px;
        }
        .logout-btn{
            background:#dc2626;
            color:#fff;
            border:none;
            padding:8px 14px;
            border-radius:6px;
            cursor:pointer;
        }
        .logout-btn:hover{
            background:#b91c1c;
        }
        .cards{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
            gap:20px;
        }
        .card{
            background:#fff;
            padding:22px;
            border-radius:12px;
            box-shadow:0 6px 18px rgba(0,0,0,0.06);
        }
        .card h4{
            margin:0;
            font-size:13px;
            color:#64748b;
            font-weight:500;
        }
        .card p{
            margin-top:12px;
            font-size:28px;
            font-weight:600;
            color:#0f172a;
        }
        .section-title{
            margin-top:35px;
            margin-bottom:15px;
            font-size:18px;
            font-weight:600;
            color:#0f172a;
        }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>suraj</h2>

  <div class="nav-item" onclick="location.href='/'">Dashboard</div>
  <div class="nav-item" onclick="location.href='/inventory'">Live Inventory</div>
  <div class="nav-item" onclick="location.href='/assets'">Assets</div>
  <div class="nav-item" onclick="location.href='/users'">Users</div>
  <div class="nav-item" onclick="location.href='/reports'">Reports</div>

  {% if role == "admin" %}
  <div class="nav-item" onclick="location.href='/settings'">
    Settings
  </div>
  {% endif %}
</div>


<!-- MAIN -->
<div class="main">
    <div class="header">
        <span>Welcome, {{ session['user'] }}</span>
        <button class="logout-btn" onclick="location.href='/logout'">Logout</button>
    </div>

    <div class="section-title">Overview</div>
    <div class="cards">
        <div class="card">
            <h4>Total Assets</h4>
            <p id="totalAssets">--</p>
        </div>
        <div class="card">
            <h4>Live Assets</h4>
            <p id="liveAssets">--</p>
        </div>
        <div class="card">
            <h4>Offline Assets</h4>
            <p id="offlineAssets">--</p>
        </div>
        <div class="card">
            <h4>Total Users</h4>
            <p id="totalUsers">--</p>
        </div>
		<div class="card">
        <h4>Expiring Soon (3 Days)</h4>
        <p id="expiringSoon">0</p>
		</div>
    </div>
	<div class="section-title">Hedge Expire Alerts</div>

      <div class="card" style="max-width:500px">
         <div class="card-body p-2" style="max-height:180px;overflow:auto">
            <ul class="list-group list-group-flush" id="hedgeAlerts">
               <li class="list-group-item text-muted small">
                  No upcoming hedge expiries
               </li>
            </ul>
         </div>
     </div>
</div>



<!-- ===== LIVE COUNT JS (ONLY ADDITION) ===== -->
<script>
function loadDashboardCounts(){
 fetch("/inventory/data")
  .then(r=>r.json())
  .then(data=>{
    const live = data.length;
    document.getElementById("totalAssets").innerText = live;
    document.getElementById("liveAssets").innerText = live;
    document.getElementById("offlineAssets").innerText = 0;
    document.getElementById("totalUsers").innerText = live;
  });
}
loadDashboardCounts();
setInterval(loadDashboardCounts, 30000);

fetch("/users/data")
.then(r => r.json())
.then(users => {
  let ul = document.getElementById("hedgeAlerts");
  ul.innerHTML = "";
  let today = new Date();
  let expCount = 0;

  users.forEach(u => {
    if (!u.hedge_expire) return;

    let exp = new Date(u.hedge_expire);
    let diffDays = Math.ceil(
      (exp - today) / (1000 * 60 * 60 * 24)
    );

    if (diffDays >= 0 && diffDays <= 3) {
      expCount++;
      ul.innerHTML += `
        <li class="list-group-item small d-flex justify-content-between">
          <span>${u.current_user || "Unknown User"}</span>
          <span class="text-danger fw-bold">${u.hedge_expire}</span>
        </li>`;
    }
  });

  if (expCount === 0) {
    ul.innerHTML =
      `<li class="list-group-item text-muted small">
        No upcoming hedge expiries
      </li>`;
  }

  // âœ… YAHI MAIN FIX
  document.getElementById("expiringSoon").innerText = expCount;
});
</script>

<!-- ===== LIVE COUNT JS (ONLY ADDITION) ===== -->

</body>
</html>

